name: Daily Calibration & Report

on:
  schedule:
    # روزانه ساعت 01:00 به وقت UTC
    - cron: '0 1 * * *'
  workflow_dispatch: # امکان اجرا دستی

jobs:
  calibrate:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install node-fetch dotenv

    # --- اضافه شده برای پشتیبانی از Resilience ---
    - name: Detect Market Regime
      run: |
        echo "MARKET_REGIME=NEUTRAL" >> $GITHUB_ENV

    - name: Run scanner script
      run: node .github/scripts/scanner.js
      env:
        CG_API_KEY: ${{ secrets.CG_API_KEY }}

    - name: Run analyzer script
      run: node .github/scripts/analyzer.js
      env:
        ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}

    # --- اصلاح شده: تبدیل CSV و آپلود با curl ---
    - name: Convert CSV to JSON and Upload Calibrated Wallets to KV
      run: |
        if [ -f data/smart_wallets.csv ]; then
          echo "Converting smart_wallets.csv to JSON and uploading to KV..."
          # تأیید وجود فایل
          echo "File exists, size: $(stat -c%s data/smart_wallets.csv) bytes"
          
          # خواندن فایل CSV و تبدیل به آرایه JSON
          # فرض: ستون اول، wallet_address است. هدر را حذف می‌کنیم.
          # این کد با استفاده از sed و awk انجام می‌شود.
          # اطمینان از اینکه فیلدها با کاما جدا شده‌اند و فیلدی خود کاما ندارد.
          # خروجی: ["addr1", "addr2", ...]
          # دستور زیر خط هدر را حذف، ستون اول را استخراج، خطوط خالی را حذف، هر خط را با "،" و " نشانه گذاری و با کاما جدا می‌کند.
          # سپس کل خروجی را در بین [...] قرار می‌دهد.
          # این روش برای موارد ساده کار می‌کند.
          # اگر فرمت CSV پیچیده‌تر باشد، بهتر است از یک اسکریپت Node.js کمکی استفاده کنید.
          
          # روش جایگزین: استفاده از یک اسکریپت Node.js ساده برای تبدیل
          # ایجاد اسکریپت کمکی
          cat > convert_csv.js << 'EOF'
const fs = require('fs');
const path = require('path');

const csvPath = path.join(__dirname, '..', 'data', 'smart_wallets.csv');
if (!fs.existsSync(csvPath)) {
  console.error('CSV file not found!');
  process.exit(1);
}

const csvContent = fs.readFileSync(csvPath, 'utf8');
const lines = csvContent.split('\n').filter(line => line.trim() !== '');
if (lines.length < 2) {
  console.log('[]'); // اگر فقط هدر یا هیچ خطی نباشد
  process.exit(0);
}

const headers = lines[0].split(',');
const walletAddressIndex = headers.indexOf('wallet_address'); // تغییر این نام اگر ستون متفاوت است
if (walletAddressIndex === -1) {
  console.error('wallet_address column not found in CSV headers!');
  console.error('Headers:', headers);
  process.exit(1);
}

const wallets = [];
for (let i = 1; i < lines.length; i++) { // از خط دوم شروع (بدون هدر)
  const cols = lines[i].split(',');
  if (cols[walletAddressIndex]) {
    wallets.push(cols[walletAddressIndex].trim().toLowerCase()); // تبدیل به کوچک
  }
}
console.log(JSON.stringify(wallets));
EOF

          # اجرای اسکریپت تبدیل
          node convert_csv.js > temp_smart_wallets.json

          # چاپ محتوای تولید شده برای اطمینان
          echo "Generated JSON content:"
          cat temp_smart_wallets.json
          echo ""

          # تأیید طول فایل JSON
          json_size=$(stat -c%s temp_smart_wallets.json)
          if [ $json_size -lt 3 ]; then
            echo "ERROR: Generated JSON is empty or invalid."
            exit 1
          fi

          # آپلود با curl - تأکید بر عدم وجود فاصله اضافی در URL
          # استفاده از --fail برای بررسی کد وضعیت HTTP
          if curl -X PUT --fail -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" -H "Content-Type: application/json" --data-binary @temp_smart_wallets.json "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/storage/kv/namespaces/${{ secrets.CF_KV_NAMESPACE_ID }}/values/calibrated_wallets"; then
            echo "✅ Upload to KV successful."
          else
            echo "❌ Upload to KV failed. HTTP error code or network issue."
            exit 1
          fi

          rm temp_smart_wallets.json
          echo "Upload completed."
        else
          echo "ERROR: smart_wallets.csv file not found after running analyzer!"
          exit 1
        fi
      shell: bash

    # --- گام Commit و Push حذف شد ---
