name: Daily Calibration & Report

on:
  schedule:
    # روزانه ساعت 01:00 به وقت UTC
    - cron: '0 1 * * *'
  workflow_dispatch: # امکان اجرا دستی

jobs:
  calibrate:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install node-fetch dotenv

    # --- اضافه شده برای پشتیبانی از Resilience ---
    - name: Detect Market Regime
      run: |
        # اینجا می‌توان یک اسکریپت ساده برای تشخیص حالت بازار (مثلاً فقط گرفتن قیمت BTC از CoinGecko) اجرا کرد
        # و نتیجه را در یک متغیر محیطی قرار داد
        # برای سادگی، مستقیماً در اسکریپت اصلی انجام می‌شود
        echo "MARKET_REGIME=NEUTRAL" >> $GITHUB_ENV
      # در عمل، می‌توان از یک اسکریپت جدا مانند `node scripts/detect_regime.js` استفاده کرد

    - name: Run scanner script
      run: node .github/scripts/scanner.js # اصلاح: مسیر صحیح
      env:
        CG_API_KEY: ${{ secrets.CG_API_KEY }}

    - name: Run analyzer script
      run: node .github/scripts/analyzer.js # اصلاح: مسیر صحیح
      env:
        ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}

    # --- اصلاح شده برای خواندن CSV و آپلود JSON ---
    - name: Convert CSV to JSON and Upload Calibrated Wallets to KV
      run: |
        if [ -f data/smart_wallets.csv ]; then
          echo "Converting smart_wallets.csv to JSON and uploading to KV..."
          # خواندن خطوط فایل CSV (بدون هدر) و جدا کردن آدرس کیف (ستون اول)
          # توجه: این کد فرض می‌کند ستون اول همیشه آدرس کیف است و فیلدها با کاما جدا شده‌اند
          # و هیچ فیلدی خود کاما ندارد. در غیر این صورت، باید از یک ابزار CSV مناسب‌تر استفاده کرد.
          # ایجاد آرایه JSON
          echo "[" > temp_smart_wallets.json
          tail -n +2 data/smart_wallets.csv | while IFS=, read -r col1 col2 col3 col4 col5 col6 col7 col8 col9; do
            # حذف فاصله‌های اضافی و نقل‌قول‌های احتمالی
            addr=$(echo "$col1" | xargs | sed 's/"//g')
            if [ ! -z "$addr" ] && [ "$addr" != "wallet_address" ]; then
              # اضافه کردن آدرس به فایل، با کاما اگر نه خط اول باشد
              if [ $(stat -c%s temp_smart_wallets.json) -gt 1 ]; then
                echo "," >> temp_smart_wallets.json
              fi
              # تبدیل به حروف کوچک برای یکنواختی
              echo -n "\"$(echo $addr | tr '[:upper:]' '[:lower:]')\"" >> temp_smart_wallets.json
            fi
          done
          echo "]" >> temp_smart_wallets.json

          # چاپ محتوای فایل برای اطمینان
          echo "Generated JSON content:"
          cat temp_smart_wallets.json
          echo ""

          # آپلود با curl - تأکید بر عدم وجود فاصله اضافی در URL
          curl -X PUT "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/storage/kv/namespaces/${{ secrets.CF_KV_NAMESPACE_ID }}/values/calibrated_wallets" \
          -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          --data-binary @temp_smart_wallets.json

          # بررسی کد خروجی curl
          if [ $? -eq 0 ]; then
            echo "✅ Upload to KV successful."
          else
            echo "❌ Upload to KV failed."
            exit 1
          fi

          rm temp_smart_wallets.json
          echo "Upload completed."
        else
          echo "ERROR: smart_wallets.csv file not found after running analyzer!"
          exit 1
        fi
      shell: bash

    # --- گام Commit و Push حذف شد تا خطای 403 رفع شود ---
    # اگر نیاز به ذخیره فایل‌های خروجی در مخزن دارید، روش‌های امن‌تری وجود دارد، مانند استفاده از GitHub Artifacts یا ایجاد یک Pull Request.
